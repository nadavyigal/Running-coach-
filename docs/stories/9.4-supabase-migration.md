## Story 9.4 — Supabase Migration (RS-SUP-009)

- Summary: Migrate onboarding/profile/plan/chat persistence to Supabase as the single source of truth. Enforce hard-gated UI on startup from Supabase state, eliminate `localStorage`/Dexie gating, and finalize onboarding via an idempotent server-side RPC that guarantees a canonical `profile`, a single active `plan`, and seeded `workouts` in one transaction with RLS.

### Business Value
- Eliminates brittle local-only persistence; achieves transactional integrity, multi-device consistency, and production-grade security via RLS and server-side atomic operations.

### Scope
- In: Supabase provisioning, schema (profiles/plans/workouts/chat), RLS, idempotent `finalize_onboarding` RPC, repository layer, UI hard-gating from Supabase, tests, metrics.
- Out: Full Auth UI flows; legacy Dexie data backfill/migration automation (follow-up story); offline-first caching.

### Impacted Files
- New:
  - `V0/lib/supabase/server.ts`
  - `V0/lib/repos/onboardingRepo.ts`
  - `V0/app/api/onboarding/finalize/route.ts`
  - `V0/app/api/profile/me/route.ts` (temporary until Auth wired)
- Edits:
  - `V0/components/onboarding-screen.tsx` (call finalize; remove Dexie waits)
  - `V0/app/page.tsx` (startup gate from Supabase; remove `localStorage` gating)
  - `V0/lib/onboardingReconciliation.ts` (deprecated for gating; keep only non-gating helpers if any)
  - `V0/lib/dbUtils.ts` (remove `waitForProfileReady` gating from UI paths)
  - `V0/components/today-screen-min.tsx` (ensure reads tolerate Supabase-backed canonical state)
- Config:
  - `.env.local` — `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, feature flag `SUPABASE_ENABLED=true`

### Acceptance Criteria
- Supabase schema exists with constraints:
  - `profiles.onboarding_complete` boolean; `goal`, `experience` enums; `days_per_week` 1–7; `preferred_times` text[]; `consents` jsonb.
  - `plans` unique one-active-plan per user (partial unique index).
  - `workouts` linked to `plans`.
  - `conversations` and `conversation_messages` tables for chat.
- RLS enabled:
  - Users can only select/update their own `profile`; `plans/workouts/conversations/messages` scoped to owner.
- Atomic finalize:
  - `finalize_onboarding(p_profile jsonb, p_idempotency_key text)` upserts profile, sets `onboarding_complete=true`, ensures a single active plan (creates if missing), and seeds 3 workouts in one transaction.
  - Idempotency: repeated calls with the same key do not duplicate plans/workouts.
- UI gating from Supabase:
  - On startup, app reads Supabase to decide: show Today iff `profiles.onboarding_complete=true`, else show onboarding (or a blocking “cannot connect” screen when unreachable).
  - `localStorage` flags are not consulted for navigation; no Dexie `waitForProfileReady` checks.
- Onboarding completion:
  - Completing onboarding calls `/api/onboarding/finalize`; on success, navigate to Today without further polling.
- Tests:
  - E2E: Full onboarding → Today; reload lands on Today; workouts exist; duplicate completion safe.
  - Unit/integration: repository calls, API routes, RPC idempotency.
- Observability:
  - Events logged for finalize success/failure and latency; startup gating path emits success/failure stats.

### Dev Tasks
- Supabase SQL
  - Create tables: `profiles`, `plans`, `workouts`, `conversations`, `conversation_messages`, `idempotency_keys`.
  - Add constraints and indexes (including partial unique for one active plan).
  - Enable RLS and add owner-scoped policies.
  - Create `finalize_onboarding` RPC (security definer) with idempotency.
- Server integration
  - Create `V0/lib/supabase/server.ts` admin client (service role key; server-only).
  - API: `V0/app/api/onboarding/finalize/route.ts` → call RPC.
  - API: `V0/app/api/profile/me/route.ts` → return `onboarding_complete` (temporary; replace with real Auth).
- Repository layer
  - `V0/lib/repos/onboardingRepo.ts` with `finalizeOnboarding(profile, idempotencyKey)` and `getOnboardingComplete()`.
- UI wiring
  - `V0/components/onboarding-screen.tsx`: invoke `finalizeOnboarding` on complete; handle success/error; remove Dexie readiness polling.
  - `V0/app/page.tsx`: on mount, call `getOnboardingComplete()`; route accordingly; remove `localStorage`/reconciliation gating.
  - Deprecate `V0/lib/onboardingReconciliation.ts` for navigation gating; leave only non-gating helpers if any.
  - Note: `localStorage` flags are ignored for gating.
- Tests
  - Unit: repo and API handlers (success, RPC error, idempotent replay).
  - Integration: finalize creates or reuses plan; policies prevent cross-user access (if testable).
  - E2E: onboarding flow to Today; refresh; duplication attempt.
- Config
  - Add env vars; feature flag `SUPABASE_ENABLED` to guard new path during rollout.

### QA Plan
- Unit:
  - Repo: happy path, RPC error paths, idempotency.
  - API: 400 no profile; 500 RPC error; 200 success shape.
- Integration:
  - One-active-plan invariant enforced; replay with same idempotency key returns existing plan.
- E2E:
  - Complete onboarding → Today shows; workouts seeded (3).
  - Reload returns to Today.
  - Re-submit completion does not duplicate data.
  - Startup offline → blocking screen (no navigation to Today).
- Evidence:
  - Screenshots or logs for RPC calls, seeded workouts, and gating transitions.

### Metrics/Monitoring
- `onboarding.finalize.rpc.latency_ms`, `onboarding.finalize.rpc.error_rate`
- `startup.gate.supabase.success_rate`, `startup.gate.supabase.fail_rate`
- `plans.active.count_per_user` sanity checks

### Feature Flag & Rollback
- Flag: `SUPABASE_ENABLED`
- Rollback: set `SUPABASE_ENABLED=false` to restore current Dexie-backed path (temporary; remove once stable).

### Risks/Assumptions
- Auth identity: temporary route uses placeholder; full Supabase Auth integration is required to fully secure RLS via JWT.
- Network dependency: startup is hard-gated; offline users see a blocking state.
- Service role key must remain server-only.
- Legacy data migration from Dexie deferred to follow-up.

### Confidence (CL%): 93




