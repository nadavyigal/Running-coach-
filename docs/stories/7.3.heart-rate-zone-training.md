# Story 7.3: Heart Rate Zone Training

**Epic:** 7 - Wearable Integration & Advanced Metrics  
**Story ID:** 7.3  
**Priority:** High  
**Estimate:** 6 story points  
**Status:** Ready for Development  

## User Story

**As a** runner with heart rate monitoring,  
**I want** to train in specific heart rate zones,  
**so that** I can optimize my training intensity and avoid overtraining.

## Acceptance Criteria

### AC1: Heart Rate Zone Calculation
- [ ] Calculate zones based on maximum heart rate (220 - age formula)
- [ ] Support lactate threshold-based zone calculation when available
- [ ] Allow manual zone threshold adjustment
- [ ] Provide multiple zone calculation methods (5-zone, 3-zone systems)
- [ ] Automatically update zones based on fitness improvements

### AC2: Real-time Zone Display
- [ ] Show current heart rate zone during workouts
- [ ] Display zone colors and names clearly
- [ ] Provide audio feedback when changing zones
- [ ] Show target zone for specific workout types
- [ ] Alert when user is outside target zone for >30 seconds

### AC3: Zone-specific Workout Recommendations
- [ ] Generate workouts targeting specific heart rate zones
- [ ] Suggest zone-based intervals and tempo runs
- [ ] Recommend recovery runs in Zone 1-2
- [ ] Create threshold workouts targeting Zone 4
- [ ] Design VO2 max intervals in Zone 5

### AC4: Post-workout Zone Analysis
- [ ] Display time spent in each heart rate zone
- [ ] Show zone distribution as percentage and absolute time
- [ ] Compare actual vs intended zone distribution
- [ ] Provide insights on workout effectiveness
- [ ] Track zone distribution trends over time

### AC5: Zone-based Coaching
- [ ] Adjust workout intensity based on zone performance
- [ ] Recommend recovery when too much time in high zones
- [ ] Suggest progression when consistently hitting zone targets
- [ ] Provide zone-specific training tips and education
- [ ] Integrate zone data with overall training plan

### AC6: Personalization & Learning
- [ ] Learn user's preferred zones and adjust recommendations
- [ ] Track zone accuracy and provide improvement suggestions
- [ ] Adapt zone boundaries based on performance data
- [ ] Consider external factors (weather, stress, fatigue)
- [ ] Provide seasonal periodization of zone-based training

## Technical Requirements

### Heart Rate Zone Calculations
```typescript
interface HeartRateZoneSettings {
  id: string;
  userId: number;
  calculationMethod: 'max_hr' | 'lactate_threshold' | 'hrr' | 'manual';
  maxHeartRate?: number;
  restingHeartRate?: number;
  lactateThresholdHR?: number;
  zoneSystem: 'five_zone' | 'three_zone' | 'custom';
  customZones?: CustomZone[];
  autoUpdate: boolean;
  lastCalculated: Date;
  createdAt: Date;
  updatedAt: Date;
}

interface HeartRateZone {
  id: string;
  userId: number;
  zoneNumber: number;
  name: string;
  description: string;
  minBpm: number;
  maxBpm: number;
  color: string;
  targetPercentage?: number; // for workout planning
  trainingBenefit: string;
  createdAt: Date;
  updatedAt: Date;
}

interface ZoneDistribution {
  id: string;
  runId: number;
  zone1Time: number; // seconds
  zone2Time: number;
  zone3Time: number;
  zone4Time: number;
  zone5Time: number;
  zone1Percentage: number;
  zone2Percentage: number;
  zone3Percentage: number;
  zone4Percentage: number;
  zone5Percentage: number;
  totalTime: number;
  createdAt: Date;
}
```

### Zone Calculation Algorithms
```typescript
// Maximum Heart Rate Method (5-zone system)
function calculateMaxHRZones(maxHR: number): HeartRateZone[] {
  return [
    { zone: 1, name: 'Recovery', min: 0, max: Math.round(maxHR * 0.60), color: '#blue' },
    { zone: 2, name: 'Aerobic Base', min: Math.round(maxHR * 0.60), max: Math.round(maxHR * 0.70), color: '#green' },
    { zone: 3, name: 'Aerobic', min: Math.round(maxHR * 0.70), max: Math.round(maxHR * 0.80), color: '#yellow' },
    { zone: 4, name: 'Threshold', min: Math.round(maxHR * 0.80), max: Math.round(maxHR * 0.90), color: '#orange' },
    { zone: 5, name: 'VO2 Max', min: Math.round(maxHR * 0.90), max: maxHR, color: '#red' },
  ];
}

// Lactate Threshold Method
function calculateLTZones(lactateThresholdHR: number): HeartRateZone[] {
  return [
    { zone: 1, name: 'Recovery', min: 0, max: Math.round(lactateThresholdHR * 0.75), color: '#blue' },
    { zone: 2, name: 'Aerobic', min: Math.round(lactateThresholdHR * 0.75), max: Math.round(lactateThresholdHR * 0.85), color: '#green' },
    { zone: 3, name: 'Tempo', min: Math.round(lactateThresholdHR * 0.85), max: Math.round(lactateThresholdHR * 0.95), color: '#yellow' },
    { zone: 4, name: 'Threshold', min: Math.round(lactateThresholdHR * 0.95), max: Math.round(lactateThresholdHR * 1.05), color: '#orange' },
    { zone: 5, name: 'Anaerobic', min: Math.round(lactateThresholdHR * 1.05), max: 220, color: '#red' },
  ];
}
```

### API Endpoints
- `GET /api/heart-rate/zones` - Get user's current heart rate zones
- `PUT /api/heart-rate/zones/settings` - Update zone calculation settings
- `POST /api/heart-rate/zones/calculate` - Recalculate zones
- `GET /api/heart-rate/zones/distribution/{runId}` - Get zone distribution for run
- `GET /api/workouts/zone-based` - Get zone-specific workout recommendations
- `POST /api/heart-rate/zones/feedback` - Submit zone accuracy feedback

## UI/UX Requirements

### Zone Setup & Configuration
1. **Zone Calculation Method Selection**
   - Radio buttons for calculation methods
   - Input fields for max HR, resting HR, LT HR
   - Auto-detect option using recent run data
   - Preview of calculated zones

2. **Zone Customization Interface**
   - Interactive sliders for zone boundaries
   - Color picker for zone visualization
   - Zone name and description editing
   - Save/reset to defaults options

3. **Zone System Selection**
   - 5-zone system (default)
   - 3-zone simplified system
   - Custom zone count option
   - Explanation of each system's benefits

### Real-time Zone Display
1. **During Workout**
   - Large current heart rate number
   - Current zone name and color background
   - Zone progress bar or gauge
   - Target zone indicator
   - Audio alerts toggle

2. **Zone Target Display**
   - Target zone for current workout segment
   - Time remaining in target zone
   - Visual feedback (green=good, red=outside target)
   - Guidance arrows (↑ speed up, ↓ slow down)

### Post-workout Zone Analysis
1. **Zone Distribution Chart**
   - Pie chart showing percentage in each zone
   - Bar chart showing time in each zone
   - Comparison with target distribution
   - Workout effectiveness score

2. **Zone Timeline**
   - Heart rate timeline with zone coloring
   - Interactive chart to zoom in on segments
   - Markers for zone changes
   - Workout interval overlays

3. **Zone Insights & Recommendations**
   - Effectiveness analysis ("Great aerobic base building!")
   - Recommendations for improvement
   - Comparison with similar workouts
   - Next workout suggestions

## Testing Strategy

### Unit Tests
- [ ] Heart rate zone calculation algorithms
- [ ] Zone distribution analysis logic
- [ ] Real-time zone detection accuracy
- [ ] Workout recommendation engine
- [ ] Zone boundary validation

### Integration Tests
- [ ] Zone calculation with different methods
- [ ] Real-time zone updates during simulated runs
- [ ] Zone-based workout generation
- [ ] Historical zone trend analysis
- [ ] Multi-device heart rate source handling

### User Acceptance Tests
- [ ] Zone setup flow with different user profiles
- [ ] Real-time zone guidance during actual runs
- [ ] Post-workout analysis accuracy
- [ ] Zone-based coaching effectiveness
- [ ] Audio alert timing and clarity

## Implementation Plan

### Week 1: Zone Calculation Foundation
- [ ] Implement zone calculation algorithms
- [ ] Create zone configuration database schema
- [ ] Build zone setup and customization UI
- [ ] Add zone calculation API endpoints

### Week 2: Real-time Zone Features
- [ ] Implement real-time zone detection
- [ ] Create zone display during workouts
- [ ] Add audio alerts and feedback
- [ ] Build target zone guidance system

### Week 3: Analysis & Coaching
- [ ] Implement post-workout zone analysis
- [ ] Create zone distribution visualizations
- [ ] Add zone-based workout recommendations
- [ ] Integrate with coaching algorithm

## Dependencies

### Technical Dependencies
- Heart rate data from connected devices (Story 7.1, 7.2)
- Real-time data processing infrastructure
- Audio alert system for workout feedback
- Advanced charting library for visualizations

### Design Dependencies
- Zone color scheme and branding
- Real-time workout interface designs
- Chart and visualization components
- Audio alert sound design

### Product Dependencies
- Workout recommendation algorithm updates
- Coaching intelligence integration
- User onboarding flow for zone setup
- Educational content about heart rate training

## Definition of Done

### Functional Requirements
- [ ] Users can calculate and customize heart rate zones
- [ ] Real-time zone display works during workouts
- [ ] Zone-based workout recommendations generate appropriately
- [ ] Post-workout zone analysis provides accurate insights
- [ ] Audio alerts trigger at correct zone transitions
- [ ] Zone data integrates with coaching algorithms

### Quality Requirements
- [ ] Zone calculation accuracy verified against industry standards
- [ ] Real-time zone detection has <5% error rate
- [ ] Zone distribution analysis matches manual calculations
- [ ] Audio alerts have <1 second latency
- [ ] UI remains responsive during real-time updates

### Documentation
- [ ] Heart rate zone training educational content
- [ ] Zone calculation method comparison guide
- [ ] Troubleshooting guide for zone accuracy issues
- [ ] Best practices guide for zone-based training

## Risks & Mitigation

### Technical Risks
1. **Heart Rate Data Accuracy**
   - Risk: Inaccurate heart rate data leads to wrong zones
   - Mitigation: Data validation, multiple source support, user feedback

2. **Real-time Performance**
   - Risk: Zone calculations may lag during workouts
   - Mitigation: Optimized algorithms, background processing, caching

3. **Audio Alert Timing**
   - Risk: Delayed or missed audio alerts
   - Mitigation: Priority audio processing, fallback visual alerts

### Product Risks
1. **User Complexity**
   - Risk: Heart rate zones may confuse beginners
   - Mitigation: Simple default setup, educational content, progressive disclosure

2. **Zone Accuracy Perception**
   - Risk: Users may not trust calculated zones
   - Mitigation: Multiple calculation methods, manual override, validation tools

## Success Metrics

### Technical Metrics
- Zone calculation accuracy >95% vs established methods
- Real-time zone detection latency <2 seconds
- Audio alert reliability >98%
- Zone distribution calculation accuracy >99%

### User Metrics
- Zone-based training adoption >60% of heart rate users
- Zone setup completion rate >80%
- Zone-based workout completion rate >70%
- User satisfaction with zone accuracy >4.4/5

## Future Enhancements

### Short-term (Next Sprint)
- Advanced zone systems (polarized training model)
- Zone-based interval workout builder
- Heart rate variability integration
- Seasonal zone periodization

### Long-term (Future Epics)
- AI-powered zone optimization
- Environmental factor integration (heat, altitude)
- Team/coach zone monitoring dashboards
- Integration with lactate testing protocols

---

**Created:** July 18, 2025  
**Last Updated:** July 18, 2025  
**Assigned To:** [To be assigned]  
**Sprint:** [To be scheduled]