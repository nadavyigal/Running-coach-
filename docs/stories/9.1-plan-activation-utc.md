---
epic: 9
story: 9.1
title: Plan Activation UTC Timezone Handling
complexity: medium
priority: high
status: Ready for Review
---

# Story 9.1: Plan Activation UTC Timezone Handling

## Story
As a user of the running coach app traveling across timezones or living in different timezones, I need plan activation and workout scheduling to work consistently regardless of my local timezone, so that my training plan remains accurate and I don't miss scheduled workouts due to timezone confusion.

## Acceptance Criteria
- [x] Plan activation dates are stored and processed in UTC
- [x] Workout scheduling uses UTC for consistent cross-timezone behavior
- [x] Plan start/end dates handle timezone conversions correctly
- [x] User sees localized times in UI while backend uses UTC
- [x] Plan migration works correctly when users change timezones
- [x] All existing plans are migrated to use UTC timestamps

## Dev Notes
Current implementation issues identified:
1. `Plan.startDate` and `Plan.endDate` use `new Date()` without UTC consideration
2. `Workout.scheduledDate` is created with local timezone offsets
3. Plan activation in `dbUtils.ts` uses `Date.now()` which is local-timezone dependent
4. No timezone metadata stored with plans or users

Technical approach:
1. Add timezone utility functions for UTC handling
2. Update plan creation to use UTC dates
3. Add user timezone preference to User interface
4. Update workout scheduling to account for user timezone
5. Migrate existing data to UTC format

## Testing
- [x] Test plan activation across different timezones
- [x] Verify workout scheduling consistency
- [x] Test timezone migration for existing users
- [x] Verify UI displays correct local times
- [x] Test edge cases around DST transitions

## Tasks
- [x] Create UTC utility functions for date handling
- [x] Update Plan interface to include timezone metadata
- [x] Update User interface to include timezone preference
- [x] Modify plan creation functions to use UTC
- [x] Update workout scheduling to use UTC with user timezone conversion
- [x] Create migration script for existing plans
- [x] Update UI components to display localized times
- [x] Add comprehensive tests for timezone handling

## Subtasks
- [x] Create `lib/timezone-utils.ts` with UTC conversion functions
- [x] Add `timezone` field to User interface in `db.ts`
- [x] Add `createdInTimezone` field to Plan interface in `db.ts`
- [x] Update `completeOnboardingAtomic` in `dbUtils.ts` to use UTC
- [x] Update `createPlan` in `dbUtils.ts` to use UTC
- [x] Update `ensureUserHasActivePlan` in `dbUtils.ts` to use UTC
- [x] Update workout scheduling in `dbUtils.ts` to use UTC
- [x] Create timezone migration function in `dbUtils.ts`
- [x] Update plan display components to show localized times
- [x] Add timezone preference to user profile settings

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Initial implementation analysis completed
- Identified timezone issues in plan activation and scheduling

### Completion Notes
- [x] Story implementation started
- [x] UTC utility functions created
- [x] Database schema updated with timezone fields
- [x] Plan creation updated to use UTC
- [x] Workout scheduling updated to use UTC
- [x] Migration script implemented
- [x] UI updated to display localized times
- [x] Tests added and passing

### File List
Files created/modified during implementation:
- `V0/lib/timezone-utils.ts` (created - comprehensive UTC conversion functions)
- `V0/lib/db.ts` (modified - added timezone fields to User and Plan interfaces)
- `V0/lib/dbUtils.ts` (modified - updated all plan/workout functions to use UTC)
- `V0/components/plan-screen.tsx` (modified - display localized times using formatLocalizedDate)
- `V0/lib/__tests__/timezone-utils.test.ts` (created - comprehensive timezone utility tests)

### Change Log
- 2025-01-13: Story created and requirements defined
- 2025-01-13: Implemented timezone utilities with comprehensive UTC handling
- 2025-01-13: Updated database schema to include timezone fields for User and Plan
- 2025-01-13: Updated all plan creation and workout scheduling to use UTC dates
- 2025-01-13: Implemented migration function for existing plans to UTC
- 2025-01-13: Updated UI components to display localized times
- 2025-01-13: Added comprehensive test suite (17 tests, all passing)
- 2025-01-13: Story completed and marked ready for review