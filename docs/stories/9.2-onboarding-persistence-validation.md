## Story 9.2 — Onboarding State Persistence, Resume, and Validation (RS-ONB-001)

- Summary: Persist onboarding progress and partial data, resume after refresh, validate inputs server-side with telemetry, and reconcile DB vs localStorage state.

### Business Value
- Prevents drop-off due to refresh or navigation; ensures valid data and legal compliance.

### Scope
- In: step persistence/resume, server-side validation, reconciliation on app init.
- Out: visual redesign, email flows beyond “resume” entry point.

### Impacted Files
- `V0/components/onboarding-screen.tsx`
- `V0/app/page.tsx`
- `V0/lib/db.ts` (using existing `onboardingSessions`, `conversationMessages`)
- `V0/lib/onboardingAnalytics.ts`
- Onboarding API routes (add Zod validation)

### Acceptance Criteria
- Refresh mid-flow restores exact step and data; “Resume onboarding” available when incomplete.
- Invalid inputs (e.g., missing consents) rejected server-side with actionable error messages; telemetry recorded.
- DB is source of truth; localStorage used only as boot hint; reconciliation on init converges to DB.

### Dev Tasks
- Step persistence:
  - On each step change, save `{ currentStep, partialData, conversationId }` to `onboardingSessions` and mirror to `sessionStorage`.
  - On mount, if user not `onboardingComplete`, restore from DB/session.
- Validation:
  - Add Zod schemas for onboarding submissions; reject missing consent/invalid fitness; record `trackFormValidationError` and `trackOnboardingError`.
- Reconciliation:
  - `app/page.tsx` startup flow: prefer DB (`ensureUserReady`/`waitForProfileReady`), use localStorage flag as fallback; re-check DB post-load and correct UI state.
- Error boundary:
  - Wrap onboarding UI; on fatal errors, clear in-progress flags safely and present “Continue where you left off”.

### QA Plan
- Unit:
  - Zod validation coverage for consent, fitness level, age bounds, daysPerWeek.
- Integration:
  - Refresh at steps 2–8 resumes same step/data.
  - Divergent localStorage vs DB converges to DB within one load cycle.
- E2E:
  - Full onboarding → Today displays plan.
  - Incomplete onboarding shows resume prompt and properly resumes.

### Metrics/Monitoring
- `onboarding_resume_attempts/success`, `validation_failures_by_field`, `onboarding_completion_rate`.

### Feature Flag & Rollback
- Flag: `onboarding.resumePersistence`.
- Rollback: disable flag; existing flow remains.

### Risks/Assumptions
- SessionStorage mirror is best-effort; DB remains canonical.

### Confidence (CL%): 88

---

### QA Results (RS-ONB-001)
- Status: PASS
- Evidence (code-level):
  - Persistence + Resume implemented
    - `V0/components/onboarding-screen.tsx`: initializes and uses persistence via `initializeOnboardingPersistence`, `checkOnboardingResume`, `updateOnboardingStep`, with resume prompt and state restoration.
    - `V0/lib/onboardingPersistence.ts`: dual-layer persistence (IndexedDB `onboardingSessions` + `sessionStorage`), auto-save, resume validation, and clear/reset helpers.
  - Validation present
    - Client: `validateOnboardingStep` enforced before advancing steps in `onboarding-screen.tsx`.
    - Server: `V0/app/api/onboarding/validate/route.ts` calls `validateOnboardingStep` (Zod-backed) for server-side validation.
    - Telemetry: `trackFormValidationError` and `trackOnboardingError` used for failures.
  - Reconciliation on app init
    - `V0/app/page.tsx`: runs `reconcileOnboardingState()` to prefer DB state; falls back to `ensureUserReady()`; only then consults localStorage as a last resort; sets screen accordingly.
  - Atomic completion
    - `dbUtils.completeOnboardingAtomic(...)` writes user + active plan in a transaction; `waitForProfileReady()` gate used by `handleOnboardingComplete`.
- Test execution (manual review against code + existing tests):
  - Unit
    - Validation tests exist in `V0/lib/onboardingValidation.test.ts` covering steps 2,4,5,6,7 and bounds.
    - Persistence tests: `V0/lib/onboardingPersistence.test.ts` include sessionStorage fallbacks and recovery.
  - Integration
    - Resume flow in `onboarding-screen.tsx` restores step/data via `getCurrentOnboardingState()`; analytics emitted on success/failure.
  - E2E (specs present)
    - `V0/tests/e2e/onboarding-resume.spec.ts` and related E2E specs validate sessionStorage/DB resume and offline behavior.
- Minor Notes (INFO, not blocking):
  - `userId` placeholder `1` is used in persistence and reconciliation paths (e.g., `initializeOnboardingPersistence(1)`, `reconcileOnboardingState(1)`). Ensure wiring to actual authenticated user when available.
  - Consider adding a dismissible inline banner for resume availability in addition to the modal for a11y continuity.
- Recommendations:
  - Add a small smoke E2E to assert reconciliation path sets Today screen when DB says complete and localStorage is stale.
  - Ensure feature flag `onboarding.resumePersistence` is documented and toggled in CI/CD environments.
- QA Sign-off: ✅
  - Reviewer: QA (Quinn)
  - Date: 2025-08-13
